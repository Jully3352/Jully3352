<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>民航综合业务平台 v3.1</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <!-- 添加 Supabase 客户端库 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #0a5cb8;
            --accent-color: #1e88e5;
            --secondary-color: #42a5f5;
            --background-color: #f8fafd;
            --card-shadow: 0 10px 30px rgba(0, 85, 179, 0.08);
            --hover-shadow: 0 12px 30px rgba(30, 136, 229, 0.15);
            --success-color: #4CAF50;
            --warning-color: #FF9800;
            --danger-color: #f44336;
            --hot-color: #ff6b6b;
            --category-bg: #e3f2fd;
            --text-dark: #2d3748;
            --text-medium: #4a5568;
            --text-light: #718096;
            --border-color: #e2e8f0;
            --card-gradient: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(245,249,255,0.95) 100%);
            --header-gradient: linear-gradient(135deg, var(--primary-color), #003b7b);
            --sidebar-width: 280px;
            --theme-name: "默认蓝色";
        }

        /* 其他所有CSS样式保持不变... */
        /* 由于CSS代码很长，这里省略重复部分，您原来的CSS保持不变 */

        /* 添加管理员特殊样式 */
        .user-info.admin {
            background: rgba(76, 175, 80, 0.1) !important;
            color: #2e7d32 !important;
            border-left: 4px solid #4caf50 !important;
        }

        .user-info.admin::before {
            background: #4caf50 !important;
        }

        .admin-badge {
            background: #4caf50;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 8px;
            vertical-align: middle;
        }

        /* 加载状态样式 */
        .loading {
            text-align: center;
            padding: 50px;
            color: var(--text-medium);
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="theme-default">
    <div class="overlay" id="overlay"></div>
    
    <!-- 侧边栏 -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <i class="fas fa-rocket"></i>
                <span>民航业务平台</span>
            </div>
            <div class="user-info" id="usernameDisplay">
                加载中...
            </div>
        </div>
        
        <div class="sidebar-nav">
            <div class="nav-item active" data-page="home">
                <i class="fas fa-home"></i>
                <span>首页</span>
            </div>
            <div class="nav-item" data-page="tools">
                <i class="fas fa-tools"></i>
                <span>核心工具</span>
            </div>
            <div class="nav-item" data-page="analytics">
                <i class="fas fa-chart-bar"></i>
                <span>数据分析</span>
            </div>
            <div class="nav-item" data-page="audit">
                <i class="fas fa-search"></i>
                <span>审计追踪</span>
            </div>
            <div class="nav-item" data-page="tickets">
                <i class="fas fa-ticket-alt"></i>
                <span>票务管理</span>
            </div>
            <div class="nav-item" data-page="agents">
                <i class="fas fa-user-tie"></i>
                <span>代理系统</span>
            </div>
            <div class="nav-item" data-page="knowledge">
                <i class="fas fa-book"></i>
                <span>知识库</span>
            </div>
            <div class="nav-item" data-page="refunds">
                <i class="fas fa-money-bill-wave"></i>
                <span>退票服务</span>
            </div>
            <div class="nav-item" data-page="payments">
                <i class="fas fa-credit-card"></i>
                <span>支付系统</span>
            </div>
            <div class="nav-item has-submenu" id="settingsMenu">
                <i class="fas fa-cog"></i>
                <span>系统设置</span>
                <div class="submenu">
                    <div class="submenu-item theme-option theme-blue" data-theme="default">
                        <div class="theme-color"></div>
                        <span>默认蓝色</span>
                    </div>
                    <div class="submenu-item theme-option theme-green" data-theme="green">
                        <div class="theme-color"></div>
                        <span>清新绿色</span>
                    </div>
                    <div class="submenu-item theme-option theme-purple" data-theme="purple">
                        <div class="theme-color"></div>
                        <span>优雅紫色</span>
                    </div>
                    <div class="submenu-item theme-option theme-dark" data-theme="dark">
                        <div class="theme-color"></div>
                        <span>深色模式</span>
                    </div>
                    <div class="submenu-item theme-option theme-orange" data-theme="orange">
                        <div class="theme-color"></div>
                        <span>活力橙色</span>
                    </div>
                    <div class="submenu-item theme-option theme-pink" data-theme="pink">
                        <div class="theme-color"></div>
                        <span>浪漫粉色</span>
                    </div>
                    <div class="submenu-item theme-option theme-red" data-theme="red">
                        <div class="theme-color"></div>
                        <span>热情红色</span>
                    </div>
                    <div class="submenu-item theme-option theme-cyan" data-theme="cyan">
                        <div class="theme-color"></div>
                        <span>清新青色</span>
                    </div>
                    <div class="submenu-item theme-option theme-blue-purple" data-theme="blue-purple">
                        <div class="theme-color"></div>
                        <span>科技蓝紫</span>
                    </div>
                    <div class="submenu-item theme-option theme-brown" data-theme="brown">
                        <div class="theme-color"></div>
                        <span>大地棕色</span>
                    </div>
                    <div class="submenu-item theme-option theme-deep-blue" data-theme="deep-blue">
                        <div class="theme-color"></div>
                        <span>午夜深蓝</span>
                    </div>
                </div>
            </div>
            <div class="nav-item" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                <span>退出登录</span>
            </div>
        </div>
    </div>

    <!-- 主内容区 -->
    <div class="main-content">
        <header class="platform-header">
            <div class="platform-title">
                <div>
                    <div id="platformTitle">民航综合业务平台 v3.1</div>
                    <div class="platform-subtitle">高效 · 智能 · 专业 · 安全</div>
                </div>
                <div class="fade-in" style="animation-delay: 0.3s">
                    <i class="fas fa-shield-alt" style="font-size: 3rem; opacity: 0.7;"></i>
                </div>
            </div>
        </header>

        <div class="stats-bar">
            <div class="stat-card fade-in" style="animation-delay: 0.1s">
                <div class="stat-value" id="modulesCount">0</div>
                <div class="stat-label">功能模块</div>
            </div>
            <div class="stat-card fade-in" style="animation-delay: 0.2s">
                <div class="stat-value" id="airlinesCount">0</div>
                <div class="stat-label">航司系统</div>
            </div>
            <div class="stat-card fade-in" style="animation-delay: 0.3s">
                <div class="stat-value" id="toolsCount">0</div>
                <div class="stat-label">核心工具</div>
            </div>
            <div class="stat-card fade-in" style="animation-delay: 0.4s">
                <div class="stat-value">98%</div>
                <div class="stat-label">系统可用率</div>
            </div>
        </div>

        <div class="search-container">
            <div style="position: relative;">
                <input type="text" id="moduleSearch" placeholder="搜索模块、功能或关键词...">
                <i class="fas fa-search search-icon"></i>
            </div>
            
            <div class="category-filters">
                <button class="category-btn active" data-category="all">全部</button>
                <button class="category-btn" data-category="核心工具">核心工具</button>
                <button class="category-btn" data-category="数据分析">数据分析</button>
                <button class="category-btn" data-category="审计追踪">审计追踪</button>
                <button class="category-btn" data-category="票务管理">票务管理</button>
                <button class="category-btn" data-category="代理系统">代理系统</button>
                <button class="category-btn" data-category="知识库">知识库</button>
                <button class="category-btn" data-category="退票服务">退票服务</button>
                <button class="category-btn" data-category="支付系统">支付系统</button>
            </div>
        </div>

        <main>
            <h2 class="section-title"><i class="fas fa-fire"></i>热门功能</h2>
            <div class="module-grid" id="hotModules">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>正在加载热门功能...</p>
                </div>
            </div>
            
            <h2 class="section-title"><i class="fas fa-th-large"></i>所有功能</h2>
            <div class="module-grid" id="allModules">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>正在加载所有功能...</p>
                </div>
            </div>
        </main>
    </div>

    <!-- 弹窗 -->
    <div id="loginNote">
        <div class="note-header">
            <span><i class="fas fa-key"></i> <span id="platformName"></span> 登录凭证</span>
            <button class="close-btn" id="closeNoteBtn">&times;</button>
        </div>
        <div class="note-content" id="credentialContent"></div>
    </div>

    <div id="charterNote">
        <div class="note-header">
            <span><i class="fas fa-plane"></i> 包机政策查询</span>
            <button class="close-btn" id="closeCharterNoteBtn">&times;</button>
        </div>
        <div class="charter-content">
            <div class="charter-title">查询网址：</div>
            <div class="charter-link">http://tc.corp.qunar.com/newweb/index.html#/editor?fileType=table&amp;appcode=f_pangolin_search_post&amp;envType=prod&amp;envName=&amp;dataId=charter.t</div>
            
            <div class="charter-title">登录方式：</div>
            <p>第一次复制网址放入浏览器登录，然后退出，再重新复制网址登录</p>
            
            <div class="charter-title">查询方式：</div>
            <div class="charter-instruction">
                <ol>
                    <li>输入代理商【域名前3位】</li>
                    <li>输入首段航班完整的【航班号】</li>
                    <li>如可查询到即为包机政策；如查询不到则需要核实代理商，以代理告知的为准</li>
                </ol>
            </div>
            
            <div class="charter-title">注意事项：</div>
            <p>如查询到【首段报价航班号】未展示查询的航班号，可点击【导出】-【导出EXCEL】，在excel表格中查看</p>
            
            <button class="copy-btn" id="copyCharterLink" data-text="http://tc.corp.qunar.com/newweb/index.html#/editor?fileType=table&amp;appcode=f_pangolin_search_post&amp;envType=prod&amp;envName=&amp;dataId=charter.t" style="margin-top: 20px; width: 100%;">
                <i class="fas fa-copy"></i>复制查询网址
            </button>
        </div>
    </div>

    <!-- 海系非自愿退票选择弹窗 -->
    <div id="hxChoiceNote">
        <div class="note-header">
            <span><i class="fas fa-exclamation-circle"></i> 海系非自愿退票</span>
            <button class="close-btn" id="closeHxChoiceNoteBtn">&times;</button>
        </div>
        <div class="note-content">
            <p>请选择您要进行的操作：</p>
            <div class="choice-buttons">
                <button class="choice-btn" id="goToPlatformBtn">
                    <i class="fas fa-external-link-alt"></i>跳转代理人服务平台
                </button>
                <button class="choice-btn secondary" id="viewOperationBtn">
                    <i class="fas fa-book"></i>查看操作方式
                </button>
            </div>
        </div>
    </div>

    <!-- 主题指示器 -->
    <div class="theme-indicator" id="themeIndicator">
        当前主题：默认蓝色
    </div>

    <script>
        (function() {
            // Supabase 配置
            const SUPABASE_URL = 'https://wglylvfuwtwrapgkoixl.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndnbHlsdmZ1d3R3cmFwZ2tvaXhsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3NjQwMDIsImV4cCI6MjA3OTM0MDAwMn0.OiINpSKraNUZgZc1Y7CW2U7igCEJbhpZHZ3Lfqnrmyg';
            
            // 初始化 Supabase 客户端
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            const iconConfig = {
                pool: [
                    'fa-passport', 'fa-file-excel', 'fa-chart-pie', 'fa-ticket-alt',
                    'fa-plane', 'fa-ship', 'fa-train', 'fa-bus', 'fa-database',
                    'fa-cloud', 'fa-lock', 'fa-university', 'fa-chart-line',
                    'fa-cogs', 'fa-wifi', 'fa-satellite-dish', 'fa-headset',
                    'fa-qrcode', 'fa-shield-alt', 'fa-robot'
                ],
                mappings: {
                    'HU': 'fa-plane-departure',
                    '3U': 'fa-mountain',
                    'CZ': 'fa-cloud',
                    'MF': 'fa-umbrella-beach',
                    'KN': 'fa-satellite',
                    'DFT': 'fa-coins',
                    'HX': 'fa-ship'
                }
            };

            class PlatformManager {
                constructor() {
                    this.usedIcons = new Set();
                    this.currentCategory = 'all';
                    this.searchTerm = '';
                    this.currentPage = 'home';
                    this.currentTheme = localStorage.getItem('theme') || 'default';
                    this.currentHxModule = null;
                    this.modulesData = [];
                    this.currentUser = {
                        username: '用户',
                        displayName: '用户',
                        role: 'user',
                        loginTime: null
                    };
                    this.init();
                }

                async init() {
                    const authResult = await this.checkAuth();
                    if (!authResult) {
                        return;
                    }
                    
                    await this.loadModulesFromDatabase();
                    this.setupEventListeners();
                    this.renderModules();
                    this.applyTheme(this.currentTheme);
                    
                    // 添加包机弹窗关闭事件
                    document.getElementById('closeCharterNoteBtn').addEventListener('click', () => {
                        this.toggleCharterNote(false);
                    });
                    
                    // 添加复制包机链接事件
                    document.getElementById('copyCharterLink').addEventListener('click', (e) => {
                        const text = e.currentTarget.dataset.text;
                        this.copyToClipboard(text, e.currentTarget);
                    });
                    
                    // 添加海系非自愿退票选择弹窗事件
                    document.getElementById('closeHxChoiceNoteBtn').addEventListener('click', () => {
                        this.toggleHxChoiceNote(false);
                    });
                    
                    document.getElementById('goToPlatformBtn').addEventListener('click', () => {
                        window.open('https://asp.hnair.com/#/', '_blank');
                        if (this.currentHxModule) {
                            this.showCredentials(this.currentHxModule);
                        }
                        this.toggleHxChoiceNote(false);
                    });
                    
                    document.getElementById('viewOperationBtn').addEventListener('click', () => {
                        window.open('http://wh.corp.qunar.com/#/quHelp/quArticle/35114?question=%E6%B5%B7%E7%B3%BB%E9%9D%9E%E8%87%AA%E6%84%BF%E9%80%80%E5%87%AD%E8%AF%81%E4%B8%8A%E4%BC%A0', '_blank');
                        this.toggleHxChoiceNote(false);
                    });
                }

                async checkAuth() {
                    // 检查是否已登录
                    if (!sessionStorage.getItem('loggedIn')) {
                        window.location.href = 'login.html';
                        return false;
                    }
                    
                    // 获取用户信息
                    const username = sessionStorage.getItem('username') || '用户';
                    const displayName = sessionStorage.getItem('displayName') || username;
                    const userRole = sessionStorage.getItem('userRole') || 'user';
                    const loginTime = sessionStorage.getItem('loginTime');
                    
                    this.currentUser = {
                        username: username,
                        displayName: displayName,
                        role: userRole,
                        loginTime: loginTime
                    };
                    
                    // 更新界面显示
                    this.updateUserDisplay();
                    
                    console.log('用户登录信息:', this.currentUser);
                    return true;
                }

                updateUserDisplay() {
                    const userInfoElement = document.getElementById('usernameDisplay');
                    if (!userInfoElement) return;
                    
                    let displayHTML = this.currentUser.displayName;
                    
                    // 如果是管理员，添加管理员标识和样式
                    if (this.currentUser.role === 'admin') {
                        displayHTML += ' <span class="admin-badge">管理员</span>';
                        userInfoElement.classList.add('admin');
                    } else {
                        userInfoElement.classList.remove('admin');
                    }
                    
                    userInfoElement.innerHTML = displayHTML;
                    
                    // 更新平台标题（如果是管理员）
                    this.updatePlatformTitle();
                }

                updatePlatformTitle() {
                    const platformTitle = document.getElementById('platformTitle');
                    if (platformTitle && this.currentUser.role === 'admin') {
                        platformTitle.innerHTML = '民航综合业务平台 v3.1 <span style="font-size: 0.6em; background: #4caf50; color: white; padding: 2px 8px; border-radius: 12px; vertical-align: middle; margin-left: 10px;">管理员模式</span>';
                    }
                }

                // 从数据库加载模块数据
                async loadModulesFromDatabase() {
                    try {
                        console.log('开始从数据库加载模块数据...');
                        
                        const { data, error } = await supabase
                            .from('modules')
                            .select('*')
                            .order('clicks', { ascending: false });

                        if (error) {
                            console.error('从数据库加载模块时出错:', error);
                            this.modulesData = this.getDefaultModulesData();
                        } else {
                            console.log('成功从数据库加载模块数据:', data);
                            this.modulesData = data || [];
                        }

                        this.updateStats();
                    } catch (error) {
                        console.error('加载模块时发生错误:', error);
                        this.modulesData = this.getDefaultModulesData();
                        this.updateStats();
                    }
                }

                // 获取默认模块数据（数据库不可用时使用）
                getDefaultModulesData() {
                    console.log('使用默认模块数据');
                    return [
                        {
                            id: 'aviation',
                            name: '黑屏智能指令生成',
                            description: '支持身份证/护照双模式，自动生成标准民航指令',
                            url: 'pages/aviation.html',
                            tags: ['核心工具'],
                            icon: 'fa-passport',
                            clicks: 42
                        },
                        // ... 其他模块数据保持不变
                    ];
                }

                // 更新统计信息
                updateStats() {
                    const totalModules = this.modulesData.length;
                    const airlineModules = this.modulesData.filter(module => 
                        module.tags && module.tags.includes('代理系统')).length;
                    const toolModules = this.modulesData.filter(module => 
                        module.tags && module.tags.includes('核心工具')).length;

                    document.getElementById('modulesCount').textContent = totalModules;
                    document.getElementById('airlinesCount').textContent = airlineModules;
                    document.getElementById('toolsCount').textContent = toolModules;
                }

                // 保存点击数据到数据库
                async saveClickData(moduleId) {
                    const module = this.modulesData.find(m => m.id === moduleId);
                    if (module) {
                        module.clicks = (module.clicks || 0) + 1;
                        
                        try {
                            const { error } = await supabase
                                .from('modules')
                                .update({ clicks: module.clicks })
                                .eq('id', moduleId);

                            if (error) {
                                console.error('更新数据库点击量时出错:', error);
                            } else {
                                console.log(`模块 ${moduleId} 点击量更新为: ${module.clicks}`);
                            }
                        } catch (error) {
                            console.error('更新点击量时发生错误:', error);
                        }
                    }
                }

                setupEventListeners() {
                    // 搜索框功能
                    document.getElementById('moduleSearch').addEventListener('input', e => {
                        this.searchTerm = e.target.value.toLowerCase();
                        this.renderModules();
                    });

                    // 分类筛选
                    document.querySelectorAll('.category-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            document.querySelectorAll('.category-btn').forEach(b => 
                                b.classList.remove('active'));
                            btn.classList.add('active');
                            this.currentCategory = btn.dataset.category;
                            this.renderModules();
                        });
                    });

                    // 关闭凭证弹窗
                    document.getElementById('closeNoteBtn').addEventListener('click', () => {
                        this.toggleCredentialNote(false);
                    });

                    // 遮罩层点击关闭
                    document.getElementById('overlay').addEventListener('click', () => {
                        this.toggleCredentialNote(false);
                        this.toggleCharterNote(false);
                        this.toggleHxChoiceNote(false);
                    });

                    // 注销
                    document.getElementById('logoutBtn').addEventListener('click', () => {
                        sessionStorage.clear();
                        window.location.href = 'login.html';
                    });

                    // 侧边栏导航
                    document.querySelectorAll('.nav-item:not(.has-submenu):not(#logoutBtn)').forEach(item => {
                        item.addEventListener('click', () => {
                            document.querySelectorAll('.nav-item').forEach(i => 
                                i.classList.remove('active'));
                            item.classList.add('active');
                            
                            this.currentPage = item.dataset.page;
                            this.updateContentByPage();
                        });
                    });

                    // 系统设置子菜单
                    const settingsMenu = document.getElementById('settingsMenu');
                    settingsMenu.addEventListener('click', (e) => {
                        e.stopPropagation();
                        settingsMenu.classList.toggle('open');
                    });

                    // 主题选择
                    document.querySelectorAll('.theme-option').forEach(option => {
                        option.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const theme = option.dataset.theme;
                            this.applyTheme(theme);
                            
                            settingsMenu.classList.remove('open');
                        });
                    });

                    // 如果是管理员，添加管理员菜单
                    if (this.currentUser.role === 'admin') {
                        this.addAdminMenu();
                    }
                }

                addAdminMenu() {
                    const sidebarNav = document.querySelector('.sidebar-nav');
                    const settingsMenu = document.getElementById('settingsMenu');
                    
                    // 创建管理员菜单项
                    const adminMenuItem = document.createElement('div');
                    adminMenuItem.className = 'nav-item';
                    adminMenuItem.innerHTML = `
                        <i class="fas fa-user-shield"></i>
                        <span>系统管理</span>
                    `;
                    
                    // 在设置菜单前插入管理员菜单
                    sidebarNav.insertBefore(adminMenuItem, settingsMenu);
                    
                    // 添加点击事件
                    adminMenuItem.addEventListener('click', () => {
                        this.showAdminPanel();
                    });
                }

                showAdminPanel() {
                    alert('管理员功能面板\n\n当前用户: ' + this.currentUser.displayName + '\n权限: ' + (this.currentUser.role === 'admin' ? '管理员' : '普通用户') + '\n登录时间: ' + new Date(this.currentUser.loginTime).toLocaleString());
                }

                updateContentByPage() {
                    console.log(`切换到页面: ${this.currentPage}`);
                    
                    if (this.currentPage === 'home') {
                        this.currentCategory = 'all';
                        document.querySelectorAll('.category-btn').forEach(btn => {
                            btn.classList.toggle('active', btn.dataset.category === 'all');
                        });
                    } else {
                        const categoryMap = {
                            'tools': '核心工具',
                            'analytics': '数据分析',
                            'audit': '审计追踪',
                            'tickets': '票务管理',
                            'agents': '代理系统',
                            'knowledge': '知识库',
                            'refunds': '退票服务',
                            'payments': '支付系统'
                        };
                        
                        if (categoryMap[this.currentPage]) {
                            this.currentCategory = categoryMap[this.currentPage];
                            document.querySelectorAll('.category-btn').forEach(btn => {
                                btn.classList.toggle('active', btn.dataset.category === this.currentCategory);
                            });
                        }
                    }
                    
                    this.renderModules();
                }

                applyTheme(theme) {
                    document.body.className = '';
                    document.body.classList.add(`theme-${theme}`);
                    
                    localStorage.setItem('theme', theme);
                    this.currentTheme = theme;
                    
                    const themeNames = {
                        'default': '默认蓝色',
                        'green': '清新绿色',
                        'purple': '优雅紫色',
                        'dark': '深色模式',
                        'orange': '活力橙色',
                        'pink': '浪漫粉色',
                        'red': '热情红色',
                        'cyan': '清新青色',
                        'blue-purple': '科技蓝紫',
                        'brown': '大地棕色',
                        'deep-blue': '午夜深蓝'
                    };
                    
                    document.getElementById('themeIndicator').textContent = 
                        `当前主题：${themeNames[theme]}`;
                }

                renderModules() {
                    const hotContainer = document.getElementById('hotModules');
                    const allContainer = document.getElementById('allModules');
                    
                    hotContainer.innerHTML = '';
                    allContainer.innerHTML = '';
                    
                    let filteredModules = this.modulesData;
                    
                    if (this.searchTerm) {
                        filteredModules = filteredModules.filter(module => 
                            module.name.toLowerCase().includes(this.searchTerm) || 
                            module.description.toLowerCase().includes(this.searchTerm) ||
                            (module.tags && module.tags.some(tag => tag.toLowerCase().includes(this.searchTerm)))
                        );
                    }
                    
                    if (this.currentCategory !== 'all') {
                        filteredModules = filteredModules.filter(module => 
                            module.tags && module.tags.includes(this.currentCategory)
                        );
                    }
                    
                    const hotModules = [...filteredModules]
                        .sort((a, b) => (b.clicks || 0) - (a.clicks || 0))
                        .slice(0, 4)
                        .filter(module => (module.clicks || 0) > 0);
                    
                    if (hotModules.length > 0) {
                        hotModules.forEach(module => {
                            hotContainer.appendChild(this.createModuleCard(module, true));
                        });
                    } else {
                        const defaultHotModules = filteredModules.slice(0, 3);
                        defaultHotModules.forEach(module => {
                            hotContainer.appendChild(this.createModuleCard(module, true));
                        });
                    }
                    
                    if (filteredModules.length > 0) {
                        filteredModules.forEach(module => {
                            allContainer.appendChild(this.createModuleCard(module));
                        });
                    } else {
                        allContainer.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-search"></i>
                                <h3>没有找到匹配的模块</h3>
                                <p>请尝试其他搜索词或分类</p>
                            </div>
                        `;
                    }
                    
                    setTimeout(() => {
                        document.querySelectorAll('.module-card').forEach(card => {
                            card.classList.add('loaded');
                        });
                    }, 50);
                }

                // 其他方法保持不变...
            }

            document.addEventListener('DOMContentLoaded', () => new PlatformManager());
        })();
    </script>
</body>
</html>