

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能数据对比系统 - 优化版</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light-primary: #3a506b;
            --background: #f8f9fa;
            --text: #2c3e50;
            --card-bg: #ffffff;
            --border: #e0e6ed;
            --shadow: rgba(0,0,0,0.08);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e7eb 100%);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            transform: rotate(30deg);
        }

        .header h1 {
            position: relative;
            z-index: 2;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            position: relative;
            z-index: 2;
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }

        .upload-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 2rem;
            padding: 2rem;
            background: #f8fafc;
            position: relative;
        }

        .upload-card {
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            background: white;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .upload-card.active {
            border-color: var(--secondary);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.2);
            transform: translateY(-3px);
        }

        .upload-card:hover {
            border-color: var(--secondary);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .file-input {
            position: relative;
            cursor: pointer;
            z-index: 2;
        }

        .file-input input {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .file-icon {
            font-size: 3rem;
            color: var(--secondary);
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .upload-card:hover .file-icon {
            transform: scale(1.1);
        }

        .analyze-btn {
            width: 260px;
            margin: 2rem auto;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, var(--secondary), var(--light-primary));
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3);
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .analyze-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: 0.5s;
            z-index: -1;
        }

        .analyze-btn:hover::before {
            left: 100%;
        }

        .analyze-btn:hover {
            transform: translateY(-3px) scale(1.03);
            box-shadow: 0 8px 15px rgba(52, 152, 219, 0.4);
        }

        .analyze-btn:active {
            transform: translateY(1px);
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            padding: 1.5rem 2rem;
            background: #f0f4f8;
            border-bottom: 1px solid var(--border);
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.95rem;
        }

        .total-orders .stat-value { color: var(--primary); }
        .matched .stat-value { color: var(--success); }
        .errors .stat-value { color: var(--danger); }
        .new-records .stat-value { color: var(--secondary); }

        .control-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background: white;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            gap: 1rem;
        }

        .search-box {
            position: relative;
            flex: 1;
            max-width: 400px;
        }

        .search-box input {
            width: 100%;
            padding: 0.8rem 1rem 0.8rem 3rem;
            border: 1px solid var(--border);
            border-radius: 50px;
            font-size: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2);
        }

        .search-box i {
            position: absolute;
            left: 1.2rem;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
        }

        .filter-controls {
            display: flex;
            gap: 0.8rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.6rem 1.2rem;
            background: white;
            border: 1px solid var(--border);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-btn.active {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }

        .result-section {
            padding: 0 1rem 2rem;
        }

        .result-table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .result-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 800px;
        }

        .result-table th,
        .result-table td {
            padding: 14px 16px;
            text-align: left;
        }

        .result-table th {
            background: var(--primary);
            color: white;
            position: sticky;
            top: 0;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .result-table th:hover {
            background: var(--light-primary);
        }

        .result-table th i {
            margin-left: 5px;
            opacity: 0.7;
        }

        .result-table tr:nth-child(even) {
            background-color: #f9fafb;
        }

        .result-table tr:hover {
            background-color: #f0f7ff;
        }

        .status {
            display: inline-flex;
            align-items: center;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.9em;
            gap: 0.5rem;
            font-weight: 500;
            min-width: 100px;
            justify-content: center;
        }

        .match { background: #e8f5e9; color: #2e7d32; }
        .error-status { background: #ffebee; color: #c62828; }
        .new-record { background: #e3f2fd; color: #1565c0; }

        .diff-container {
            padding: 10px;
            background: #fff;
            border-radius: 8px;
            margin: 5px 0;
        }

        .diff-row {
            display: flex;
            align-items: center;
            margin: 6px 0;
        }

        .diff-label {
            width: 100px;
            color: #666;
            font-size: 0.9em;
            font-weight: 500;
        }

        .diff-value {
            flex: 1;
            padding: 4px 10px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .diff-danger {
            background: #fff0f0;
            color: #c62828;
            border-left: 3px solid #e74c3c;
        }

        .diff-success {
            background: #f0f9eb;
            color: #2e7d32;
            border-left: 3px solid #27ae60;
        }

        .diff-value i {
            font-size: 0.8em;
            opacity: 0.7;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--secondary);
            display: none;
        }

        .loading i {
            font-size: 3rem;
            margin-bottom: 1.5rem;
            animation: spin 1.5s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 8px;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .error { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
        .success { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }

        /* 弹窗样式 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
            backdrop-filter: blur(3px);
        }

        .modal-container {
            background: white;
            border-radius: 16px;
            width: 85%;
            max-width: 900px;
            max-height: 85vh;
            overflow-y: auto;
            padding: 2.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: modalFadeIn 0.4s ease;
            position: relative;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #eee;
        }

        .modal-title {
            font-size: 1.6rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #999;
            transition: color 0.2s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .modal-close:hover {
            background: #f8f9fa;
            color: var(--danger);
        }

        .issue-list {
            margin-top: 1.5rem;
        }

        .issue-item {
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s ease;
            border-radius: 8px;
        }

        .issue-item:hover {
            background: #f9fafb;
        }

        .issue-item:last-child {
            border-bottom: none;
        }

        .issue-order {
            font-weight: bold;
            color: var(--primary);
            min-width: 120px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .issue-type {
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            min-width: 100px;
            text-align: center;
            font-weight: 500;
        }

        .type-mismatch { background: #ffebee; color: #c62828; }
        .type-missing { background: #e3f2fd; color: #1565c0; }
        .type-new { background: #e8f5e9; color: #2e7d32; }

        .issue-details {
            flex: 1;
            padding: 0 1.5rem;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .show-details-btn {
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.6rem 1.2rem;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .show-details-btn:hover {
            background: var(--light-primary);
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(52, 152, 219, 0.3);
        }

        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 2rem;
            gap: 0.5rem;
        }

        .page-btn {
            padding: 0.6rem 1rem;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .page-btn:hover {
            background: #f0f4f8;
        }

        .page-btn.active {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }

        .return-btn {
            background: var(--primary);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.8rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .return-btn:hover {
            background: var(--light-primary);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
        }

        @media (max-width: 992px) {
            .header h1 { font-size: 2rem; }
            .header p { font-size: 1rem; }
            .stat-value { font-size: 1.8rem; }
            .modal-container { width: 95%; padding: 1.5rem; }
        }

        @media (max-width: 768px) {
            .container { border-radius: 0; }
            .upload-section { grid-template-columns: 1fr; padding: 1.5rem; }
            .analyze-btn { width: 100%; }
            .result-table { font-size: 0.9em; }
            .stats-container { grid-template-columns: 1fr 1fr; }
            .control-panel { flex-direction: column; align-items: stretch; }
            .search-box { max-width: 100%; }
            .filter-controls { justify-content: center; }
            .modal-container { width: 98%; padding: 1rem; }
            .issue-item { flex-wrap: wrap; }
            .issue-order, .issue-type { margin-bottom: 0.5rem; }
            .issue-details { padding: 0.5rem 0; width: 100%; }
            .show-details-btn { margin-top: 0.5rem; margin-left: 0; width: 100%; justify-content: center; }
        }

        @media (max-width: 480px) {
            .stats-container { grid-template-columns: 1fr; }
            .stat-card { padding: 1.2rem; }
            .diff-label { width: 85px; }
            .header { padding: 1.5rem 1rem; }
        }
    </style>
</head>
<body>
    <div style="margin-bottom: 20px; display: flex; justify-content: center;">
        <a href='/'>
            <button class="return-btn">
                <i class="fas fa-arrow-left"></i> 返回主页
            </button>
        </a>
    </div>

    <div class="container">
        <div class="header">
            <h1><i class="fas fa-file-csv"></i> 智能数据对比系统</h1>
            <p>订单数据精准匹配与差异分析 - 高效识别数据差异，提升数据处理效率</p>
        </div>

        <div class="upload-section">
            <div class="upload-card" id="baseCard">
                <div class="file-input">
                    <input type="file" id="baseFile" accept=".xlsx, .xls">
                    <i class="fas fa-file-upload file-icon"></i>
                    <h3>基准文件</h3>
                    <p id="baseFileName">点击或拖拽上传Excel文件</p>
                </div>
            </div>

            <div class="upload-card" id="compareCard">
                <div class="file-input">
                    <input type="file" id="compareFile" accept=".xlsx, .xls">
                    <i class="fas fa-file-import file-icon"></i>
                    <h3>对比文件</h3>
                    <p id="compareFileName">点击或拖拽上传Excel文件</p>
                </div>
            </div>
        </div>

        <button class="analyze-btn" onclick="startAnalysis()">
            <i class="fas fa-play"></i> 开始智能分析
        </button>

        <div class="stats-container">
            <div class="stat-card total-orders">
                <div class="stat-value">0</div>
                <div class="stat-label">总订单数</div>
            </div>
            <div class="stat-card matched">
                <div class="stat-value">0</div>
                <div class="stat-label">匹配订单数</div>
            </div>
            <div class="stat-card errors">
                <div class="stat-value">0</div>
                <div class="stat-label">异常订单数</div>
            </div>
            <div class="stat-card new-records">
                <div class="stat-value">0</div>
                <div class="stat-label">新增记录数</div>
            </div>
        </div>

        <div class="control-panel">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="输入订单号搜索...">
            </div>
            <div class="filter-controls">
                <button class="filter-btn active" data-filter="all">
                    <i class="fas fa-list"></i> 全部
                </button>
                <button class="filter-btn" data-filter="match">
                    <i class="fas fa-check-circle"></i> 匹配
                </button>
                <button class="filter-btn" data-filter="error">
                    <i class="fas fa-exclamation-circle"></i> 异常
                </button>
                <button class="filter-btn" data-filter="new">
                    <i class="fas fa-plus-circle"></i> 新增
                </button>
            </div>
        </div>

        <div class="result-section">
            <div id="loading" class="loading">
                <i class="fas fa-spinner"></i>
                <p>数据分析中，请稍候...</p>
            </div>

            <div id="notification" class="notification"></div>

            <div class="result-table-container">
                <table class="result-table">
                    <thead>
                        <tr>
                            <th onclick="sortTable('orderId')">订单号 <i class="fas fa-sort"></i></th>
                            <th onclick="sortTable('status')">匹配状态 <i class="fas fa-sort"></i></th>
                            <th>详细对比</th>
                        </tr>
                    </thead>
                    <tbody id="resultBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 差异详情弹窗 -->
    <div class="modal-overlay" id="differenceModal">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i> 数据差异详情
                </h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalContent">
                <p>共发现 <span id="totalIssues">0</span> 处差异：</p>
                <div class="issue-list" id="issueList"></div>
                <div class="pagination" id="pagination"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script>
        const CONFIG = {
            TARGET_FIELDS: ['订单号', '订单收款金额', '赔付金额', '兜底票新票总价', '外采平台', '外采支付账号', '兜底乘机人', '兜底新票号'],
            AMOUNT_TOLERANCE: 0.01,  // 降低容差到0.01
            SIMILARITY_THRESHOLD: 1,
            FIELD_WEIGHTS: {
                amount: 0.4,
                compensation: 0.2,
                total: 0.2,
                platform: 0.1,
                payment: 0.1,
                passenger: 0.0,
                ticket: 0.0
            },
            ALLOWED_TYPES: [
                'application/vnd.ms-excel',
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
            ],
            ITEMS_PER_PAGE: 10
        };

        class DataProcessor {
            static sanitizeHeader(header) {
                return header.trim()
                    .replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '')
                    .toLowerCase();
            }

            static parseNumber(value) {
                const num = Number(String(value)
                    .replace(/[^0-9.-]/g, '')
                    .replace(/,/g, ''));
                return isNaN(num) ? 0 : Number(num.toFixed(2)); // 保留2位小数
            }

            static cleanPassengerString(value) {
                return String(value || '')
                    .trim()
                    .replace(/ +/g, ' ')
                    .replace(/ , /g, ',')
                    .replace(/(,\s*)+/g, ',')
                    .replace(/(,\s*$)/g, '');
            }

            static async parseExcel(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const sheet = workbook.Sheets[workbook.SheetNames[0]];
                            const rawData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                            if (rawData.length < 2) throw new Error('文件数据为空');

                            const headers = rawData[0].map(this.sanitizeHeader);
                            const fieldMap = CONFIG.TARGET_FIELDS.reduce((map, field) => {
                                const clean = this.sanitizeHeader(field);
                                const index = headers.indexOf(clean);
                                if (index === -1) throw new Error(`缺少字段: ${field}`);
                                map[field] = index;
                                return map;
                            }, {});

                            const processedData = rawData.slice(1)
                                .filter(row => row[fieldMap['订单号']])
                                .map(row => ({
                                    orderId: String(row[fieldMap['订单号']]).trim(),
                                    amount: this.parseNumber(row[fieldMap['订单收款金额']]),
                                    compensation: this.parseNumber(row[fieldMap['赔付金额']]),
                                    total: this.parseNumber(row[fieldMap['兜底票新票总价']]),
                                    platform: String(row[fieldMap['外采平台']] || '').trim(),
                                    payment: String(row[fieldMap['外采支付账号']] || '').trim(),
                                    passenger: this.cleanPassengerString(row[fieldMap['兜底乘机人']] || ''),
                                    ticket: String(row[fieldMap['兜底新票号']] || '').trim()
                                }));

                            resolve(processedData.filter(item => item.orderId));
                        } catch (error) {
                            reject(error);
                        }
                    };
                    reader.onerror = () => reject(new Error('文件读取失败'));
                    reader.readAsArrayBuffer(file);
                });
            }
        }

        class SmartComparator {
            constructor(baseData) {
                // 存储所有基准数据，包括重复订单
                this.baseData = baseData;
                
                // 创建映射，允许同一订单号对应多个记录
                this.baseMap = baseData.reduce((map, item, index) => {
                    if (!map.has(item.orderId)) map.set(item.orderId, []);
                    map.get(item.orderId).push({...item, originalIndex: index});
                    return map;
                }, new Map());
            }

            findBestMatch(compareItem) {
                const candidates = this.baseMap.get(compareItem.orderId) || [];
                if (candidates.length === 0) return null;

                return candidates
                    .map(baseItem => ({
                        ...baseItem,
                        similarity: this.calculateSimilarity(baseItem, compareItem)
                    }))
                    .sort((a, b) => b.similarity - a.similarity)[0];
            }

            calculateSimilarity(baseItem, compareItem) {
                let score = 0;
                
                const amountDiff = Math.abs(baseItem.amount - compareItem.amount);
                const amountSimilarity = 1 - Math.min(amountDiff / (baseItem.amount || 1), 1);
                
                const compensationMatch = 
                    Math.abs(baseItem.compensation - compareItem.compensation) <= CONFIG.AMOUNT_TOLERANCE ? 1 : 0;
                
                const totalMatch = 
                    Math.abs(baseItem.total - compareItem.total) <= CONFIG.AMOUNT_TOLERANCE ? 1 : 0;

                const platformMatch = 
                    baseItem.platform === compareItem.platform ? 1 : 0;
                    
                const paymentMatch = 
                    baseItem.payment === compareItem.payment ? 1 : 0;

                return (amountSimilarity * CONFIG.FIELD_WEIGHTS.amount) +
                       (compensationMatch * CONFIG.FIELD_WEIGHTS.compensation) +
                       (totalMatch * CONFIG.FIELD_WEIGHTS.total) +
                       (platformMatch * CONFIG.FIELD_WEIGHTS.platform) +
                       (paymentMatch * CONFIG.FIELD_WEIGHTS.payment);
            }

            compare(compareData) {
                const allIssues = [];
                const matchedBaseIndices = new Set();
                
                const results = compareData.map(item => {
                    const bestMatch = this.findBestMatch(item);
                    
                    if (!bestMatch) {
                        allIssues.push({
                            orderId: item.orderId,
                            type: '新增记录',
                            details: '对比文件中新增的记录',
                            diffs: this.getDifferences(null, item)
                        });
                        return this.createNewRecordResult(item);
                    }

                    // 标记已匹配的基准记录
                    matchedBaseIndices.add(bestMatch.originalIndex);

                    // 检查所有字段是否完全匹配
                    const isExactMatch = this.checkExactMatch(bestMatch, item);
                    
                    if (!isExactMatch) {
                        const similarity = this.calculateSimilarity(bestMatch, item);
                        allIssues.push({
                            orderId: item.orderId,
                            type: '数据异常',
                            details: this.getDifferenceDetails(bestMatch, item),
                            diffs: this.getDifferences(bestMatch, item)
                        });
                        
                        return {
                            orderId: item.orderId,
                            status: '数据异常',
                            similarity,
                            baseData: bestMatch,
                            compareData: item,
                            diffs: this.getDifferences(bestMatch, item)
                        };
                    }

                    return {
                        orderId: item.orderId,
                        status: '匹配',
                        similarity: 1,
                        baseData: bestMatch,
                        compareData: item,
                        diffs: this.getDifferences(bestMatch, item)
                    };
                });

                // 检查基准文件中未匹配的记录
                this.baseData.forEach((baseItem, index) => {
                    if (!matchedBaseIndices.has(index)) {
                        allIssues.push({
                            orderId: baseItem.orderId,
                            type: '缺失记录',
                            details: '基准文件中的记录在对比文件中缺失',
                            diffs: this.getDifferences(baseItem, {
                                orderId: baseItem.orderId,
                                amount: 0,
                                compensation: 0,
                                total: 0,
                                platform: '',
                                payment: '',
                                passenger: '',
                                ticket: ''
                            })
                        });
                    }
                });

                return { results, allIssues };
            }

            checkExactMatch(baseItem, compareItem) {
                // 修复：使用容差比较金额字段，而不是严格相等
                const amountMatch = Math.abs(baseItem.amount - compareItem.amount) <= CONFIG.AMOUNT_TOLERANCE;
                const compensationMatch = Math.abs(baseItem.compensation - compareItem.compensation) <= CONFIG.AMOUNT_TOLERANCE;
                const totalMatch = Math.abs(baseItem.total - compareItem.total) <= CONFIG.AMOUNT_TOLERANCE;
                
                return baseItem.orderId === compareItem.orderId &&
                       amountMatch &&
                       compensationMatch &&
                       totalMatch &&
                       baseItem.platform === compareItem.platform &&
                       baseItem.payment === compareItem.payment &&
                       baseItem.passenger === compareItem.passenger &&
                       baseItem.ticket === compareItem.ticket;
            }

            getDifferenceDetails(baseItem, compareItem) {
                const diffs = [];
                
                // 修复：使用容差比较金额差异
                if (Math.abs(baseItem.amount - compareItem.amount) > CONFIG.AMOUNT_TOLERANCE) {
                    diffs.push(`金额: ${baseItem.amount.toFixed(2)} → ${compareItem.amount.toFixed(2)}`);
                }
                if (Math.abs(baseItem.compensation - compareItem.compensation) > CONFIG.AMOUNT_TOLERANCE) {
                    diffs.push(`赔付: ${baseItem.compensation.toFixed(2)} → ${compareItem.compensation.toFixed(2)}`);
                }
                if (Math.abs(baseItem.total - compareItem.total) > CONFIG.AMOUNT_TOLERANCE) {
                    diffs.push(`总价: ${baseItem.total.toFixed(2)} → ${compareItem.total.toFixed(2)}`);
                }
                if (baseItem.platform !== compareItem.platform) {
                    diffs.push(`平台: ${baseItem.platform || '空'} → ${compareItem.platform || '空'}`);
                }
                if (baseItem.payment !== compareItem.payment) {
                    diffs.push(`账号: ${baseItem.payment || '空'} → ${compareItem.payment || '空'}`);
                }
                if (baseItem.passenger !== compareItem.passenger) {
                    diffs.push(`乘机人: ${baseItem.passenger || '空'} → ${compareItem.passenger || '空'}`);
                }
                if (baseItem.ticket !== compareItem.ticket) {
                    diffs.push(`新票号: ${baseItem.ticket || '空'} → ${compareItem.ticket || '空'}`);
                }
                
                return diffs.join('; ') || '无详细差异信息';
            }

            createNewRecordResult(item) {
                return {
                    orderId: item.orderId,
                    status: '新增记录',
                    similarity: 0,
                    baseData: null,
                    compareData: item,
                    diffs: this.getDifferences(null, item)
                };
            }

            getDifferences(baseItem, compareItem) {
                const diffs = {};
                
                const checkDiff = (field, label) => {
                    const baseVal = baseItem ? baseItem[field] : null;
                    const compareVal = compareItem[field];
                    const diff = baseItem ? Math.abs(baseVal - compareVal) : null;

                    // 修复：使用容差判断是否有差异
                    const hasDiff = baseItem ? 
                        (diff > CONFIG.AMOUNT_TOLERANCE) : 
                        true;

                    diffs[field] = {
                        label,
                        base: baseVal?.toFixed?.(2) ?? (baseVal || '-'),
                        compare: compareVal?.toFixed?.(2) ?? compareVal,
                        diff: diff?.toFixed?.(2) ?? '-',
                        hasDiff
                    };
                };

                const checkStringDiff = (field, label) => {
                    const baseVal = baseItem ? baseItem[field] : null;
                    const compareVal = compareItem[field];
                    
                    diffs[field] = {
                        label,
                        base: baseVal ?? '-',
                        compare: compareItem[field],
                        hasDiff: baseVal !== compareVal
                    };
                };

                checkDiff('amount', '订单收款金额');
                checkDiff('compensation', '赔付金额');
                checkDiff('total', '兜底票新票总价');
                checkStringDiff('platform', '外采平台');
                checkStringDiff('payment', '外采支付账号');
                checkStringDiff('passenger', '兜底乘机人'); 
                checkStringDiff('ticket', '兜底新票号');    

                return diffs;
            }
        }

        class UIController {
            static elements = {
                loading: document.getElementById('loading'),
                notification: document.getElementById('notification'),
                resultBody: document.getElementById('resultBody'),
                baseFileName: document.getElementById('baseFileName'),
                compareFileName: document.getElementById('compareFileName'),
                baseCard: document.getElementById('baseCard'),
                compareCard: document.getElementById('compareCard'),
                totalOrders: document.querySelector('.total-orders .stat-value'),
                matchedOrders: document.querySelector('.matched .stat-value'),
                errorOrders: document.querySelector('.errors .stat-value'),
                newRecords: document.querySelector('.new-records .stat-value')
            }

            static showLoading(show) {
                this.elements.loading.style.display = show ? 'block' : 'none';
            }

            static showNotification(message, type = 'success') {
                const notification = this.elements.notification;
                notification.className = `notification ${type}`;
                notification.innerHTML = message;
                notification.style.display = 'block';
                setTimeout(() => notification.style.display = 'none', 5000);
            }

            static updateResults(results) {
                this.elements.resultBody.innerHTML = results.map(result => {
                    const statusClass = result.status === '匹配' ? 'match' : 
                                     result.status === '新增记录' ? 'new-record' : 'error-status';
                    
                    return `
                        <tr class="result-row" data-status="${result.status === '匹配' ? 'match' : 
                                                          result.status === '新增记录' ? 'new' : 'error'}" 
                            data-order="${result.orderId}">
                            <td>${result.orderId}</td>
                            <td>
                                <span class="status ${statusClass}">
                                    ${result.status === '匹配' ? '<i class="fas fa-check"></i>' : 
                                      result.status === '新增记录' ? '<i class="fas fa-plus"></i>' : 
                                      '<i class="fas fa-exclamation"></i>'}
                                    ${result.status}
                                </span>
                            </td>
                            <td>
                                <div class="diff-container">
                                    ${this.renderFieldDiff(result.diffs.amount)}
                                    ${this.renderFieldDiff(result.diffs.compensation)}
                                    ${this.renderFieldDiff(result.diffs.total)}
                                    ${this.renderFieldDiff(result.diffs.platform)}
                                    ${this.renderFieldDiff(result.diffs.payment)}
                                    ${this.renderFieldDiff(result.diffs.passenger)}
                                    ${this.renderFieldDiff(result.diffs.ticket)}
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            static renderFieldDiff(diff) {
                if (!diff) return '';
                const formatValue = (value) => {
                    if (typeof value === 'number') return Number(value).toFixed(2);
                    if (value === null || value === undefined) return '-';
                    return value;
                };

                const isNumeric = typeof diff.base === 'number' || typeof diff.compare === 'number' || 
                                (diff.base !== '-' && !isNaN(parseFloat(diff.base))) || 
                                (diff.compare !== '-' && !isNaN(parseFloat(diff.compare)));
                const diffClass = diff.hasDiff ? 'diff-danger' : 'diff-success';
                
                return `
                    <div class="diff-row">
                        <div class="diff-label">${diff.label}</div>
                        <div class="diff-value ${diffClass}">
                            <span title="基准值">${formatValue(diff.base)}</span>
                            <i class="fas fa-arrow-right"></i>
                            <span title="对比值">${formatValue(diff.compare)}</span>
                            ${diff.hasDiff && isNumeric && diff.diff !== '-' ? 
                                `<span class="diff-danger" style="margin-left:8px;">Δ${formatValue(diff.diff)}</span>` : 
                                ''}
                        </div>
                    </div>
                `;
            }

            static updateFileDisplay(inputId, fileName) {
                const display = document.getElementById(inputId);
                display.textContent = fileName || '点击或拖拽上传Excel文件';
                display.style.color = fileName ? 'var(--text)' : '#666';
            }

            static updateStats(total, matched, errors, newRecords) {
                this.elements.totalOrders.textContent = total;
                this.elements.matchedOrders.textContent = matched;
                this.elements.errorOrders.textContent = errors;
                this.elements.newRecords.textContent = newRecords;
            }

            static toggleUploadCard(card, active) {
                if (active) {
                    card.classList.add('active');
                } else {
                    card.classList.remove('active');
                }
            }
        }

        // 初始化拖拽上传功能
        function initDragAndDrop() {
            const cards = [UIController.elements.baseCard, UIController.elements.compareCard];
            
            cards.forEach(card => {
                card.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    UIController.toggleUploadCard(card, true);
                });
                
                card.addEventListener('dragleave', () => {
                    UIController.toggleUploadCard(card, false);
                });
                
                card.addEventListener('drop', (e) => {
                    e.preventDefault();
                    UIController.toggleUploadCard(card, false);
                    
                    if (e.dataTransfer.files.length) {
                        const fileInput = card.querySelector('input[type="file"]');
                        fileInput.files = e.dataTransfer.files;
                        
                        const event = new Event('change', { bubbles: true });
                        fileInput.dispatchEvent(event);
                    }
                });
            });
        }

        // 分页显示问题列表
        function renderIssueList(issues, page = 1) {
            const issueList = document.getElementById('issueList');
            const pagination = document.getElementById('pagination');
            const totalPages = Math.ceil(issues.length / CONFIG.ITEMS_PER_PAGE);
            
            // 清空现有内容
            issueList.innerHTML = '';
            pagination.innerHTML = '';
            
            // 计算当前页的数据
            const startIndex = (page - 1) * CONFIG.ITEMS_PER_PAGE;
            const endIndex = Math.min(startIndex + CONFIG.ITEMS_PER_PAGE, issues.length);
            const pageIssues = issues.slice(startIndex, endIndex);
            
            // 渲染问题列表
            issueList.innerHTML = pageIssues.map(issue => `
                <div class="issue-item">
                    <span class="issue-order">
                        <i class="fas fa-hashtag"></i> ${issue.orderId}
                    </span>
                    <span class="issue-type ${getIssueTypeClass(issue.type)}">
                        ${issue.type}
                    </span>
                    <span class="issue-details">${issue.details}</span>
                    <button class="show-details-btn" onclick="showIssueDetails('${issue.orderId}')">
                        <i class="fas fa-search"></i> 详情
                    </button>
                </div>
            `).join('');
            
            // 渲染分页控件
            if (totalPages > 1) {
                for (let i = 1; i <= totalPages; i++) {
                    const btn = document.createElement('button');
                    btn.className = `page-btn ${i === page ? 'active' : ''}`;
                    btn.textContent = i;
                    btn.onclick = () => renderIssueList(issues, i);
                    pagination.appendChild(btn);
                }
            }
        }

        function showModal(issues) {
            const modal = document.getElementById('differenceModal');
            const totalIssues = document.getElementById('totalIssues');
            
            totalIssues.textContent = issues.length;
            renderIssueList(issues);
            
            modal.style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('differenceModal').style.display = 'none';
        }

        function getIssueTypeClass(type) {
            return {
                '数据异常': 'type-mismatch',
                '缺失记录': 'type-missing',
                '新增记录': 'type-new'
            }[type] || '';
        }

        function showIssueDetails(orderId) {
            alert(`订单 ${orderId} 的详细差异信息将在控制台显示`);
            console.log(`订单 ${orderId} 的详细差异信息`, 
                window.currentIssues.find(i => i.orderId === orderId)?.diffs);
        }

        // 搜索功能
        function initSearch() {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', () => {
                const searchTerm = searchInput.value.toLowerCase().trim();
                const rows = document.querySelectorAll('.result-row');
                
                rows.forEach(row => {
                    const orderId = row.getAttribute('data-order').toLowerCase();
                    if (orderId.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        }

        // 筛选功能
        function initFilters() {
            const filterBtns = document.querySelectorAll('.filter-btn');
            
            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const filter = btn.getAttribute('data-filter');
                    
                    // 更新按钮状态
                    filterBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // 应用筛选
                    const rows = document.querySelectorAll('.result-row');
                    
                    rows.forEach(row => {
                        const status = row.getAttribute('data-status');
                        if (filter === 'all' || filter === status) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    });
                });
            });
        }

        // 排序功能
        function sortTable(column) {
            const rows = Array.from(document.querySelectorAll('.result-row'));
            const isAsc = !window.sortAsc;
            window.sortAsc = isAsc;
            
            rows.sort((a, b) => {
                let aValue, bValue;
                
                if (column === 'orderId') {
                    aValue = a.getAttribute('data-order');
                    bValue = b.getAttribute('data-order');
                    return isAsc ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
                } else if (column === 'status') {
                    aValue = a.getAttribute('data-status');
                    bValue = b.getAttribute('data-status');
                    return isAsc ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
                }
                
                return 0;
            });
            
            const tbody = document.getElementById('resultBody');
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
        }

        async function startAnalysis() {
            try {
                UIController.showLoading(true);
                UIController.elements.resultBody.innerHTML = '';

                const baseFile = document.getElementById('baseFile').files[0];
                const compareFile = document.getElementById('compareFile').files[0];

                if (!baseFile || !compareFile) throw new Error('请选择两个对比文件');
                if (!CONFIG.ALLOWED_TYPES.includes(baseFile.type) || 
                    !CONFIG.ALLOWED_TYPES.includes(compareFile.type)) {
                    throw new Error('仅支持Excel文件 (.xls, .xlsx)');
                }

                const [baseData, compareData] = await Promise.all([
                    DataProcessor.parseExcel(baseFile),
                    DataProcessor.parseExcel(compareFile)
                ]);

                if (baseData.length === 0) throw new Error('基准文件没有有效数据');
                if (compareData.length === 0) throw new Error('对比文件没有有效数据');

                // 检查重复订单号
                const baseOrderIds = baseData.map(item => item.orderId);
                const baseUniqueOrderIds = new Set(baseOrderIds);
                if (baseOrderIds.length !== baseUniqueOrderIds.size) {
                    UIController.showNotification('注意：基准文件中存在重复订单号', 'warning');
                }

                const comparator = new SmartComparator(baseData);
                const { results, allIssues } = comparator.compare(compareData);
                
                // 存储当前问题以供查看详情
                window.currentIssues = allIssues;

                UIController.updateResults(results);
                
                // 更新统计信息
                const total = results.length;
                const matched = results.filter(r => r.status === '匹配').length;
                const errors = results.filter(r => r.status === '数据异常').length;
                const newRecords = results.filter(r => r.status === '新增记录').length;
                UIController.updateStats(total, matched, errors, newRecords);
                
                const successMsg = `分析完成：共处理 ${total} 条记录，发现 ${allIssues.length} 处差异`;
                UIController.showNotification(successMsg, allIssues.length ? 'warning' : 'success');
                
                // 如果有差异则显示弹窗
                if (allIssues.length > 0) {
                    showModal(allIssues);
                }

            } catch (error) {
                UIController.showNotification(`错误: ${error.message}`, 'error');
                console.error('分析错误:', error);
            } finally {
                UIController.showLoading(false);
            }
        }

        // 初始化页面
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化文件选择
            document.querySelectorAll('input[type="file"]').forEach(input => {
                input.addEventListener('change', function() {
                    const displayId = this.id + 'Name';
                    UIController.updateFileDisplay(displayId, this.files[0]?.name);
                });
            });

            // 初始化拖拽上传
            initDragAndDrop();
            
            // 初始化搜索
            initSearch();
            
            // 初始化筛选
            initFilters();
            
            // 点击弹窗外部关闭
            document.getElementById('differenceModal').addEventListener('click', function(e) {
                if (e.target === this) closeModal();
            });
            
            // 初始化排序状态
            window.sortAsc = true;
        });
    </script>
</body>
</html>